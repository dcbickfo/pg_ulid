/*-------------------------------------------------------------------------
 *
 * ulid.h
 *    ULID (Universally Unique Lexicographically Sortable Identifier) data type
 *
 * Copyright (c) 2025
 *
 * Portions Copyright (c) 2007-2025, PostgreSQL Global Development Group
 * (Data type structure patterns)
 *
 * Crockford Base32 encoding/decoding tables inspired by public domain ULID
 * implementations including https://github.com/skeeto/ulid-c (Unlicense)
 *
 * This code is released under the MIT License.
 * See LICENSE file in the root directory.
 *
 *-------------------------------------------------------------------------
 */

#ifndef ULID_ULID_H
#define ULID_ULID_H

/* ULID size in bytes (128 bits) */
#define ULID_LEN 16
/* ULID encoded string length (26 characters in Crockford base32) */
#define ULID_ENCODED_LEN 26

typedef struct pg_ulid_t {
	unsigned char data[ULID_LEN];
} pg_ulid_t;

/*
 * Crockford base32 decoding table.
 * Maps ASCII characters to 5-bit values (0-31).
 * 0xFF indicates invalid characters.
 * Supports both uppercase and lowercase input.
 */
static const uint8 DEC[256] = {
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10,
	0x11, 0xFF, 0x12, 0x13, 0xFF, 0x14, 0x15, 0xFF, 0x16, 0x17, 0x18, 0x19,
	0x1A, 0xFF, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 0x10, 0x11, 0xFF, 0x12, 0x13,
	0xFF, 0x14, 0x15, 0xFF, 0x16, 0x17, 0x18, 0x19, 0x1A, 0xFF, 0x1B, 0x1C,
	0x1D, 0x1E, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF,
	0xFF, 0xFF, 0xFF, 0xFF,
};

/*
 * Crockford base32 encoding alphabet.
 * Uses 0-9, A-Z excluding I, L, O, U to avoid confusion.
 */
static const char C32_ENCODING[] = "0123456789ABCDEFGHJKMNPQRSTVWXYZ";

static inline Datum ULIDPGetDatum(const pg_ulid_t *X) {
	return PointerGetDatum(X);
}

#define PG_RETURN_ULID_P(X) return ULIDPGetDatum(X)

static inline pg_ulid_t *DatumGetULIDP(Datum X) {
	return (pg_ulid_t *)DatumGetPointer(X);
}

#define PG_GETARG_ULID_P(X) DatumGetULIDP(PG_GETARG_DATUM(X))

/*
 * Internal comparison function for ULIDs.
 * Inlined for performance since it's called frequently by comparison operators.
 */
static inline int ulid_internal_cmp(const pg_ulid_t *arg1,
                                    const pg_ulid_t *arg2) {
	return memcmp(arg1->data, arg2->data, ULID_LEN);
}

#endif // ULID_ULID_H
