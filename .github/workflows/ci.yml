name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: PostgreSQL ${{ matrix.pg }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        pg: [12, 13, 14, 15, 16, 17, 18]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL ${{ matrix.pg }}
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-${{ matrix.pg }} postgresql-server-dev-${{ matrix.pg }}

      - name: Build extension
        run: |
          make PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config

      - name: Install extension
        run: |
          sudo make install PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config

      - name: Start PostgreSQL
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "CREATE DATABASE contrib_regression;"

      - name: Run tests
        run: |
          sudo make installcheck PG_CONFIG=/usr/lib/postgresql/${{ matrix.pg }}/bin/pg_config PGUSER=postgres

      - name: Show regression diffs on failure
        if: failure()
        run: |
          if [ -f regression.diffs ]; then
            cat regression.diffs
          fi

  docker-test:
    name: Docker Test (pgxn-tools)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tests with pgxn-tools
        run: |
          docker run --rm -w /repo -v "$PWD:/repo" pgxn/pgxn-tools sh -c 'pg-start 18 && pg-build-test'
